#!/usr/bin/env python

"""
Use cases

codev init --template=[template]
    -- create new project

codev install [environment] [infrastructure] [version]
    -- install project

codev start [environment] [infrastructure] [version]
    -- start installed project

codev stop [environment] [infrastructure] [version]
    -- stop installed project

codev run [script] [environment] [infrastructure] [version]
"""

import click
import os.path

from codev.configuration import YAMLConfigurationWriter
from codev.cli import command, main


@main.command()
@click.option('-p', '--path', default='.codev', help='Path to configuration file.')
def init(path):
    """
    Create .codev file in current directory or in given file path.
    """
    if os.path.isdir(path):
        path = os.path.join(path, '.codev')

    if os.path.exists(path):
        if not click.confirm('A file "%(filepath)s" already exists. Overwrite?' % {'filepath': path}):
            raise click.Abort()

    try:
        YAMLConfigurationWriter().save_to_file(path)
    except Exception as e:
        raise click.ClickException(e)


@command(
    confirmation='Install project "{configuration.project}" on environment "{deployment.environment_name}" with infrastructure "{deployment.infrastructure_name}" at installation "{deployment.installation_name}"',
    perform=True
)
def install(deployment, perform):
    """
    Install project
    """
    if perform:
        deployment.provision()
    else:
        deployment.install()


@command()
def join(deployment):
    """
    Join the actual running command in isolation
    """
    deployment.join()


@command()
@click.argument('command', nargs=-1)
def execute(deployment, command):
    """
    Execute command in isolation
    """
    deployment.execute(' '.join(command))


@command()
def stop(deployment):
    """
    Stop the actual running command in isolation
    """
    if deployment.stop():
        deployment.join()


@command()
def kill(deployment):
    """
    Kill the actual running command in isolation
    """
    if deployment.kill():
        deployment.join()


@command(
    confirmation='Execute script "{script}" at project "{configuration.project}" on environment "{deployment.environment_name}" with infrastructure "{deployment.infrastructure_name}" at installation "{deployment.installation_name}"'
)
@click.argument('script')
def run(deployment, script):
    deployment.run(script)


if __name__ == "__main__":
    main()

